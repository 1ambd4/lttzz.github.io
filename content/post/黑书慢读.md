---
title: "é»‘ä¹¦æ…¢è¯»"
date: 2021-01-14T10:44:51+08:00
lastmod: 2021-01-14T10:44:51+08:00
draft: false
keywords: []
description: ""
tags: ["reading", "notes", "csapp", "sicp"]
categories: []
author: "lttzz"

# You can also close(false) or open(true) something for this content.
# P.S. comment can only be closed
comment: false
toc: true
autoCollapseToc: true
postMetaInFooter: false
hiddenFromHomePage: false
# You can also define another contentCopyright. e.g. contentCopyright: "This is another copyright."
contentCopyright: false
reward: false
mathjax: true
mathjaxEnableSingleDollar: true
mathjaxEnableAutoNumber: true

# You unlisted posts you might want not want the header or footer to show
hideHeaderAndFooter: false

# You can enable or disable out-of-date content warning for individual post.
# Comment this out to use the global config.
#enableOutdatedInfoWarning: false

flowchartDiagrams:
  enable: false
  options: ""

sequenceDiagrams: 
  enable: false
  options: ""

---

åˆ«ç¬‘äº†åˆ«ç¬‘äº†ï¼Œçœ‹å®Œäº†çœ‹å®Œäº†ã€‚

<!--more-->

# æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆcsappï¼‰

## 0x00 æ¦‚è¿°

$700$+â€‹pï¼Œç»å¯¹çš„å¤§éƒ¨å¤´ï¼Œç„¶è€Œå¾ˆé€‚åˆå¤§ä¸€å¤§äºŒè¿™ä¸ªæ ·å­è¯»ï¼Œå»ºç«‹èµ·å…³äºè®¡ç®—æœºçš„big picture ~~ï¼ˆä¸çŸ¥é“å’‹ç²¾å‡†çš„ç¿»è¯‘è¿™ä¸ªè¯ç»„ï¼Œçœ‹è¿‡MIT 18.06, Linear Algebra çš„åº”è¯¥ç»å¸¸å¬åˆ°*Gilbert Strang* æåŠï¼‰~~ï¼Œå¯¹äºä¹‹åçš„æ·±å…¥å­¦ä¹ ç›Šå¤„å¤šå¤šã€‚

## 0x01 è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸

## 0x02 ä¿¡æ¯çš„è¡¨ç¤ºå’Œå¤„ç†

## 0x03 ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º

### æ¦‚è¿°

åŸºäºx86-64çš„ATTæ ¼å¼æ±‡ç¼–ï¼Œæ—¨åœ¨æ•™ä¼šè¯»è€…çœ‹æ‡‚æ±‡ç¼–ï¼Œæ‰€ä»¥ä¸åŒäºç‹çˆ½æ±‡ç¼–çš„ç»“æ„ï¼Œæ²¡æœ‰å¾ˆç³»ç»Ÿ ~~æ¨¡å¼åŒ–~~ çš„è‡ªåº•å‘ä¸Šè®²è§£æ±‡ç¼–è¯­æ³•ï¼Œè€Œæ˜¯ä»cè¯­è¨€ä»£ç ç”Ÿæˆæ±‡ç¼–ä»£ç ï¼Œè‡ªé¡¶å‘ä¸‹çš„è®²è§£ã€‚

## 0x04 å¤„ç†å™¨ä½“ç³»ç»“æ„

## 0x05 ä¼˜åŒ–ç¨‹åºæ€§èƒ½

ç¨‹åºæ€§èƒ½çš„ä¼˜åŒ–è¦è€ƒè™‘ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€æ˜¯ç¼–ç¨‹è¯­è¨€çº§çš„ï¼Œæ¶ˆé™¤ä¸å¿…è¦çš„å·¥ä½œï¼Œå¦‚ä¸å¿…è¦çš„å‡½æ•°è°ƒç”¨ã€æ¡ä»¶æµ‹è¯•å’Œå†…å­˜å¼•ç”¨ï¼›äºŒæ˜¯åœ¨äº†è§£å¤„ç†å™¨è¿ä½œçš„åŸºç¡€ä¸Šï¼Œå……åˆ†åˆ©ç”¨å¤„ç†å™¨æä¾›çš„æŒ‡ä»¤å¹¶è¡Œèƒ½åŠ›ï¼ŒåŒæ—¶æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ã€‚

ç ”ç©¶ç¨‹åºçš„æ±‡ç¼–ä»£ç è¡¨ç¤ºï¼Œä¸æ–­ä¿®æ”¹æºä»£ç ï¼Œè§†å›¾æ¬ºéª—ç¼–è¯‘å™¨ä»¥ç”Ÿæˆé«˜æ•ˆçš„æœºå™¨æŒ‡ä»¤æ˜¯ç¼–å†™é«˜æ€§èƒ½ç¨‹åºçš„ä¸»è¦æ–¹å¼ã€‚

### è¡¨ç¤ºç¨‹åºçš„æ€§èƒ½

å¼•å…¥åº¦é‡æ ‡å‡†æ¯å…ƒç´ çš„å‘¨æœŸæ•°ï¼ˆCycle Per Elementï¼ŒCPEï¼‰ã€‚

![psum1 and psum2](/Picbed/2021_02/0202_03.png)

![cpe](/Picbed/2021_02/0202_02.png)

ç”¨æœ€å°äºŒä¹˜æ³•æ‹Ÿåˆæ•°æ®ï¼Œ$pusm1 : y = 368 + 9n$ï¼Œ$pusm2: y = 368 + 6n$ï¼Œé‚£ä¹ˆè®°pusm1å’Œpusm2çš„CPEåˆ†åˆ«ä¸º $9$ å’Œ $6$ã€‚ï¼ˆå¤§ $O$ è®°æ³•é‡Œé¢çš„å¿½ç•¥æ‰çš„ç³»æ•°ï¼Œç²’åº¦ä¸åŒå§ï¼ŒCPEæ›´ç²¾ç»†äº›ã€‚

### ä¼˜åŒ–ç¼–è¯‘å™¨çš„èƒ½åŠ›å’Œå±€é™æ€§

#### Memory Aliasing

å¤§å¤šæ•°çš„ç¼–è¯‘å™¨ï¼Œå¦‚GCCéƒ½æä¾›äº†ä¼˜åŒ–æœºåˆ¶ï¼Œä» $O0$ ~ $O3$ ä¼˜åŒ–ç­‰çº§é€æ¸å‡é«˜ï¼Œæ­¤å¤–è¿˜æœ‰ç”¨æ¥ä¼˜åŒ–ä»£ç å°ºå¯¸çš„$Os$ã€‚

å®é™…ä¸Šï¼Œç¼–è¯‘å™¨åœ¨è¿›è¡Œä¼˜åŒ–çš„æ—¶å€™ï¼Œä¹Ÿä¼šé‡åˆ°å¾ˆå¤šçº ç»“çš„åœ°æ–¹ã€‚

``` c
// åªä»å†…å­˜è®¿é—®çš„è§’åº¦çœ‹ï¼Œtwiddle1è¯»*xä¸¤æ¬¡ï¼Œè¯»*yä¸¤æ¬¡ï¼Œå†™*xä¸¤æ¬¡ï¼Œä¸€å…±å…­æ¬¡
void twiddle1(int *x, int *y)
{
    *x += *y;
    *x += *y;
}
// twiddle2è¯»*xä¸€æ¬¡ï¼Œè¯»*yä¸€æ¬¡ï¼Œå†™*xä¸€æ¬¡ï¼Œä¸€å…±ä¸‰æ¬¡
void twiddle2(int *x, int *y)
{
    *x += 2 * *y;
} 

// é‚£ä¹ˆæ˜¯ç¼–è¯‘å™¨å¦èƒ½å°†twiddle1ä¼˜åŒ–æˆtwiddle2å‘¢ï¼Ÿ
// ä¸èƒ½çš„ï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„æƒ…å†µæ˜¯å†…å­˜åˆ«åä½¿ç”¨
// è€ƒè™‘ x==y çš„æƒ…å†µï¼Œtwiddle1æœ€åçš„ç»“æœæ˜¯å¢åŠ ååˆå¢åŠ ï¼Œæœ€åå˜æˆäº†å››å€çš„åŸå€¼
// twiddle2åˆ™æ˜¯ç›´æ¥åŠ äº†ä¸¤å€ï¼Œæœ€åå˜æˆäº†ä¸‰å€çš„åŸå€¼
// ä¹Ÿå°±æ˜¯è¯´ï¼Œtwiddle1å’Œtwiddle2å¹¶ä¸æ˜¯ç­‰ä»·çš„ï¼Œå¹¶ä¸èƒ½è¿™æ ·å­ä¼˜åŒ–
```

ç¼–è¯‘å™¨çš„ä¼˜åŒ–å°±è¿™ä¹ˆè¾£é¸¡å—ï¼Ÿä¸æ˜¯ã€‚

``` c
#include <stdio.h>

void sum(int a, int b)
{
    int c = a + b;
}

int main(void)
{
    sum(1, 2);

    return 0;
}
```

çŒœçŒœGCCä¼šå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ

``` assembly
; -O0
; æ˜¾ç„¶å°±æ˜¯ç›´æ¥ç¿»è¯‘äº†ï¼Œä¼ å‚ã€å‡½æ•°è°ƒç”¨éƒ½æœ‰
0000000000001131 <main>:
    1131:	55                   	push   %rbp
    1132:	48 89 e5             	mov    %rsp,%rbp
    1135:	be 02 00 00 00       	mov    $0x2,%esi
    113a:	bf 01 00 00 00       	mov    $0x1,%edi
    113f:	e8 d5 ff ff ff       	callq  1119 <sum>
    1144:	b8 00 00 00 00       	mov    $0x0,%eax
    1149:	5d                   	pop    %rbp
    114a:	c3                   	retq   
    114b:	0f 1f 44 00 00       	nopl   0x0(%rax,%rax,1)
    
; -O1
; ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ
; æƒ³æƒ³æ²¡æ¯›ç—…ï¼Œä¸»å‡½æ•°è°ƒç”¨äº†ä¸€ä¸ªæ²¡åµç”¨çš„å‡½æ•°ï¼Œç›´æ¥ä¼˜åŒ–æ‰å¥½äº†
000000000000111a <main>:
    111a:	b8 00 00 00 00       	mov    $0x0,%eax
    111f:	c3                   	retq

; -O2
0000000000001020 <main>:
    1020:	31 c0                	xor    %eax,%eax
    1022:	c3                   	retq   
    1023:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)
    102a:	00 00 00 
    102d:	0f 1f 00             	nopl   (%rax)

; -O3
0000000000001020 <main>:
    1020:	31 c0                	xor    %eax,%eax
    1022:	c3                   	retq   
    1023:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)
    102a:	00 00 00 
    102d:	0f 1f 00             	nopl   (%rax)

; -Os
0000000000001020 <main>:
    1020:	31 c0                	xor    %eax,%eax
    1022:	c3                   	retq   
    1023:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)
    102a:	00 00 00 
    102d:	0f 1f 00             	nopl   (%rax)
    
; O2 å’Œ O3 åˆé‡‡å–äº†ä¸åŒçš„ä¼˜åŒ–æ€è·¯ï¼ˆä½†æˆ‘æ²¡çœ‹æ‡‚
; gdb åæ±‡ç¼–å‡ºæ¥çš„æ˜¯ä¸‹é¢è¿™æ ·ï¼Œèƒ½ç†è§£
Dump of assembler code for function main:
   0x0000000000001020 <+0>:	xor    eax,eax
   0x0000000000001022 <+2>:	ret 
```

å¯ä»¥çœ‹åˆ°ï¼Œç¼–è¯‘å™¨ä¼šæŠŠâ€œåƒåœ¾â€ä¼˜åŒ–æ‰ã€‚å¾ˆæ£’å“ï¼Œå†çœ‹ä¸€ä¸ªä¾‹å­ï¼š

``` c
int x = 1000;
int y = 3000;
*q = y;			// 3000
*p = x;			// 1000
t1 = *q;		// 1000 or 3000
```

åŒæ ·ä¹Ÿæ˜¯å†…å­˜åˆ«åå¼•ç”¨é—®é¢˜ï¼Œqå’Œpå¯èƒ½æŒ‡å‘åŒä¸€å—å†…å­˜æ‰€ä»¥å¹¶ä¸èƒ½å°†ç¬¬äº”è¡Œä»£ç ä¼˜åŒ–æ‰ï¼Œè™½ç„¶å®ƒâ€œçœ‹èµ·æ¥â€æ²¡å•¥å­ç”¨ï¼Œç¼–è¯‘å™¨ä¼šå‡å®šæ‰€æœ‰å¯èƒ½çš„æƒ…å†µéƒ½æœ‰å¯èƒ½å‘ç”Ÿã€‚

ç±»ä¼¼çš„è¿˜æœ‰ï¼ŒC/C++å­¦åˆ°æŒ‡é’ˆå“ªä¸€å—çš„æ—¶å€™ï¼Œå¾ˆå¤šè€å¸ˆçˆ±ä¸¾`swap()`çš„ä¾‹å­ï¼Œç„¶åå˜ï¼Œæœ‰å¦‚ä¸‹ç‰ˆæœ¬

``` c
#include <stdio.h>

int swap(int *x, int *y)
{
    *x = *x + *y;   // x+y
    *y = *x - *y;   // x+y-y = x
    *x = *x - *y;   // x+y-x = y
}

int main(void)
{
    int a = 1, b = 2;
    printf("a = %d, b = %d\n", a, b);
    swap(&a, &b);
    printf("a = %d, b = %d\n", a, b);

    return 0;
}

// $ ./a.out 
// a = 1, b = 2
// a = 2, b = 1
```

ç¼–è¯‘è¿è¡Œï¼Œ`swap()`çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯å½“`swap(&a, &a)`å‘¢ï¼Ÿæ˜¾ç„¶æ˜¯æŠŠä¼ è¿›æ¥çš„å‚æ•°ç»™æ¸…é›¶äº†ã€‚è¯´è¿™ä¸ªä¾‹å­åœ¨äºï¼Œå†…å­˜åˆ«åå¼•ç”¨çš„é—®é¢˜ä¸å…‰æ˜¯ä¼šè®©ç¼–è¯‘å™¨å¤´ç–¼ã€‚

#### å‡½æ•°è°ƒç”¨

é™¤äº†å†…å­˜åˆ«åå¼•ç”¨ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–è¿‡ç¨‹ä¸­é‡åˆ°çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯å‡½æ•°è°ƒç”¨ã€‚

``` c
#include <stdio.h>

int counter = 0;

int f()
{
    return counter++;
}

int func1()
{
    return f() + f() + f() + f();
}

int func2()
{
    return 4 * f();
}

int main(void)
{
    // printf("func1: %d\n", func1());
    printf("func1: %d\n", func2());

    return 0;
}
```

æ˜¯ä¸èƒ½å°†`func1()`éšæ„åœ°ä¼˜åŒ–æˆ`func2()`çš„ï¼Œå°½ç®¡`func2()`æ€§èƒ½ä¼šå¥½å¾—å¤šã€‚ç¼–è¯‘å™¨ä¾æ—§æ˜¯å‡è®¾äº†æœ€ç³Ÿç³•çš„æƒ…å†µï¼Œå³æ‰€æœ‰çš„å‡½æ•°éƒ½æœ‰å‰¯ä½œç”¨ï¼Œå¹¶ä¿æŒæ‰€æœ‰çš„å‡½æ•°è°ƒç”¨å…³ç³»ä¸å˜ã€‚

C++å¼•å…¥äº†`inline`å…³é”®å­—ï¼Œå°†æ˜¯å¦ä¼˜åŒ–ï¼ˆå±•å¼€ï¼‰çš„å»ºè®®æƒäº¤ç»™ç¨‹åºå‘˜ã€‚

``` c++
// ç¼–è¯‘å‚æ•°ï¼š g++ counter.c -g -O1

// int f()
0000000000001139 <_Z1fv>:
    1139:	8b 05 f5 2e 00 00    	mov    0x2ef5(%rip),%eax        # 4034 <counter>
    113f:	8d 50 01             	lea    0x1(%rax),%edx
    1142:	89 15 ec 2e 00 00    	mov    %edx,0x2eec(%rip)        # 4034 <counter>
    1148:	c3                   	retq   
0000000000001149 <_Z5func1v>:
    1149:	53                   	push   %rbx
    114a:	e8 ea ff ff ff       	callq  1139 <_Z1fv>
    114f:	89 c3                	mov    %eax,%ebx
    1151:	e8 e3 ff ff ff       	callq  1139 <_Z1fv>
    1156:	01 c3                	add    %eax,%ebx
    1158:	e8 dc ff ff ff       	callq  1139 <_Z1fv>
    115d:	01 c3                	add    %eax,%ebx
    115f:	e8 d5 ff ff ff       	callq  1139 <_Z1fv>
    1164:	01 d8                	add    %ebx,%eax
    1166:	5b                   	pop    %rbx
    1167:	c3                   	retq   
0000000000001168 <_Z5func2v>:
    1168:	e8 cc ff ff ff       	callq  1139 <_Z1fv>
    116d:	c1 e0 02             	shl    $0x2,%eax
    1170:	c3                   	retq 

// inline int f()
// å¯ä»¥çœ‹åˆ°ï¼Œf()çš„æœºå™¨ç è¢«å¤åˆ¶åˆ°äº†func1å’Œfunc2ä¸­
// åœ¨func2é‡Œï¼Œæ›¿æ¢æ‰äº†å‡½æ•°è°ƒç”¨
// åœ¨func1é‡Œï¼Œä¸å…‰å±•å¼€äº†ï¼Œè¿˜è¿›è¡Œäº†ä¸€å®šçš„ä¼˜åŒ–
0000000000001139 <_Z5func1v>:
    1139:	8b 05 f5 2e 00 00    	mov    0x2ef5(%rip),%eax        # 4034 <counter>
    113f:	8d 50 04             	lea    0x4(%rax),%edx
    1142:	89 15 ec 2e 00 00    	mov    %edx,0x2eec(%rip)        # 4034 <counter>
    1148:	8d 04 85 06 00 00 00 	lea    0x6(,%rax,4),%eax
    114f:	c3                   	retq   

0000000000001150 <_Z5func2v>:
    1150:	8b 05 de 2e 00 00    	mov    0x2ede(%rip),%eax        # 4034 <counter>
    1156:	8d 50 01             	lea    0x1(%rax),%edx
    1159:	89 15 d5 2e 00 00    	mov    %edx,0x2ed5(%rip)        # 4034 <counter>
    115f:	c1 e0 02             	shl    $0x2,%eax
    1162:	c3                   	retq
```

### ä¼˜åŒ–ç¨‹åºæ€§èƒ½

#### ä¾‹å­

``` c
// æœªç»è¿‡ä¼˜åŒ–çš„åŸå§‹ä»£ç 
void combine1(vec_ptr v, data_t *dest)
{
    *dest = IDENT;
    for (int i = 0; i < vec_length(v); ++i)
    {
        data_t val;
        get_vec_element(v, i, &val);
        *dest = *dest OP val;
    }
}

// é€šè¿‡ä»£ç ç§»åŠ¨ï¼ˆcode motionï¼‰ï¼Œæ¶ˆé™¤ä½æ•ˆçš„å¾ªç¯
void combine2(vec_ptr v, data_t *dest)
{
    *dest = IDENT;
    int len = vec_length(v);
    for (int i = 0; i < len; ++i)
    {
        data_t val;
        get_vec_element(v, i, &val);
        *dest = *dest OP val;
    }
}

// æ¶ˆé™¤å¾ªç¯ä½“å†…å‡½æ•°è°ƒç”¨
// ï¼ˆç„¶é¹…æ€§èƒ½å¹¶æ²¡æœ‰å˜åŒ–ï¼Œç”šè‡³ç¨ç¨å·®äº†äº›ï¼Œè¿™åˆæ˜¯å¦å¤–çš„å½±å“å› ç´ äº†ï¼ˆä¸å¿…è¦çš„å†…å­˜å¼•ç”¨é—®é¢˜
dest_t *get_vec_start(vec_ptr v)
{
    return v->data;
}
void combine3(vec_ptr v, data_t *dest)
{
    int len = vec_length(v);
    data_t *data = get_vec_start(v);
    *dest = IDENT;
    for (int i = 0; i < len; ++i)
    {
        *dest = *dest OP data[i];
    }   
} 

// å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨
void combine4(vec_ptr v, data_t *dest)
{
    int len = vec_length(v);
    data_t *data = get_vet_start(v);
    data_t acc = IDENT;
    for (int i = 0; i < len; ++i)
    {
        acc = acc OP data[i];
    }
    *dest = acc;
}
```

#### æ¶ˆé™¤ä½æ•ˆçš„å¾ªç¯

``` c
#include <stdio.h>

size_t strlen(const char *s)
{
    long len = 0;
    while (*s != '\0')
    {
        s++;
        len++;
    }
    return len;
}

void lower1(char *s)
{
    for (int i = 0; i < strlen(s); ++i)
    {
        if (s[i] >= 'A' && s[i] <= 'Z')
            s[i] -= ('A' - 'a');
    }
}

void lower2(char *s)
{
    int len = strlen(s);
    for (int i = 0; i < len; ++i)
    {
        if (s[i] >= 'A' && s[i] <= 'Z')
            s[i] -= ('A' - 'a');
    }
}

int main(void)
{
    char s[10] = "LALALALA";
    lower1(s);
    printf("%s\n", s);

    return 0;
}
```

ç»å…¸ä¾‹å­äº†ï¼Œä»¥å‰çœŸçš„éƒ½æ˜¯æŒ‰`lower1()`å†™çš„ ~~ï¼Œç†ç”±å˜›ï¼Œè§‰å¾—å†™å±€éƒ¨å˜é‡æŒºä¸å¥½çœ‹çš„~~ï¼ŒğŸ˜…ã€‚

![lower1 VS lower2](/Picbed/2021_02/0201_01.png)

#### å‡å°‘è¿‡ç¨‹è°ƒç”¨

è§ä¾‹å­ä¸­çš„ `combine2()` => `combine3()` ã€‚

#### æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨

![combine2 VS combine3](/Picbed/2021_02/0201_02.png)

`combine3()` æ˜æ˜å‡å°‘äº†è¿‡ç¨‹è°ƒç”¨ï¼Œä¸ºä»€ä¹ˆæ€§èƒ½æ²¡æœ‰æå‡å‘¢ï¼Ÿ

``` assembly
; Inner loop of combine3. data_t = double, OP = *
; dest in %rbx, data+i in %rdx, data+length in %rax

1	.L17:								; loop:
2		vmovsd (%rbx), %xmm0			;	Read product from dest
3		vmulsd (%rdx), %xmm0, %xmm0		; 	Multiply product by data[i]
4		vmovsd %xmm0, (%rbx)			; 	Store product at dest
5		addq $8, %rdx					;	Increment data+i
6		cmpq %rax, %rdx					;	Compare to data+length
7		jne .L17						; 	if != , goto loop
```

$2$ ï½ $3$ è¡Œå¾ªç¯ä½“å†…å°†æ•°æ®è¯»å‡ºã€è®¡ç®—ã€å†™å›ï¼Œå®é™…ä¸Šæ²¡æœ‰å¿…è¦ï¼Œä¸Šä¸€æ¬¡å†™å…¥çš„æ•°å°±æ˜¯è¿™ä¸€æ¬¡è¦è¯»å‡ºçš„æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ `combine3()` æ€§èƒ½æ²¡è¾¾åˆ°é¢„æœŸæ˜¯å†…å­˜å¼•ç”¨é€ æˆçš„ã€‚

è§£å†³ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨ï¼Œå¯ä»¥é‡‡å–å¼•å…¥ç”¨ä»¥ç´¯ç§¯è®¡ç®—å€¼çš„ä¸´æ—¶å˜é‡ï¼Œåœ¨å¾ªç¯å®Œæˆåï¼Œå†å°†ç»“æœå†™å…¥åˆ°å†…å­˜ä¸­ã€‚

``` assembly
; Innver loop of combine4, data_t = double, OP = *
; acc in %xmm0, data+i in %rdx, data+length in %rax
1	.L25:								; loop:
2		vmulsd (%rdx), %xmm0, %xmm0		;	Multiply acc by data[i]
3		addq $8, %rdx					;	Increment data+i
4		cmpq %rax, %rdx					; 	Compare to data+length
5		jne .L25						; 	if != , goto loop
```

![combine3 VS combine4](/Picbed/2021_02/0202_00.png)

é‚£ä¹ˆï¼Œç¼–è¯‘å™¨æ˜¯å¦åº”è¯¥è¶³å¤Ÿä¼˜ç§€åˆ°å¯ä»¥å°† `combine3()` ä¼˜åŒ–æˆ `combine4()` å‘¢ï¼Ÿ

ä¸èƒ½ï¼ŒåŒæ ·æ˜¯å†…å­˜åˆ«åå¼•ç”¨é—®é¢˜ï¼Œå½“ `dest = get_vec_start(v) + get_vec_length(v)` æ—¶ï¼Œ`combine3()` å’Œ `combine4()` çš„ç»“æœæ˜¯ä¸åŒçš„ï¼Œå®é™…ä¸Š `combine4()` æ‰æ˜¯ç¬¦åˆé¢„æœŸåŠŸèƒ½çš„ï¼Œé—®é¢˜æ˜¯ç¼–è¯‘å™¨ä¸çŸ¥é“ç¨‹åºå‘˜å†™ä¸‹è¿™æ®µä»£ç çš„æ„å›¾ï¼Œæ‰€ä»¥é‡‡å–â€œç›´è¯‘â€çš„æ–¹å¼ï¼Œä¸åŠ æ”¹åŠ¨ã€‚

å¦‚æœéè¦è®©ç¼–è¯‘å™¨ä¼˜åŒ–å‘¢ï¼Ÿå½“å¯¹ `combine3()` å¼€ $O2$ ä¼˜åŒ–æ—¶ï¼Œæ€§èƒ½ä¾æ—§ä¼šæ¯” $O1$ å¥½å¾—å¤šï¼Œå…¶ç”Ÿæˆçš„æŒ‡ä»¤å¦‚ä¸‹ï¼š

``` assembly
; Innver loop of combine3, data_t = double, OP = *
; dest in $rbx, data+i in %rdx, data+length in %rax
; Accumulated product in %xmm0
1	.L22:								; loop:
2		vmulsd (%rdx), %xmm0, %xmm0		;	Multiply product by data[i]
3		addq $8, %rdx					;	Increment data+i
4		cmpq %rax, %rdx					; 	Compare to data+length
5		vmovsd %xmm0, (%rbx)			; 	Store product at dest
6		jne .L25						; 	if != , goto loop
```

![combine3w](/Picbed/2021_02/0202_01.png)

å’Œ`combine4()` æŒºæ¥è¿‘äº†ï¼Œä½†è¿˜æ˜¯å¿ å®çš„å®ç°äº†`combine3()`çš„Cè¯­è¨€ä»£ç ã€‚

``` c
// å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨
void combine3w(vec_ptr v, data_t *dest)
{
    int len = vec_length(v);
    data_t *data = get_vet_start(v);
    data_t acc = IDENT;
    *dest = acc;
    for (int i = 0; i < len; ++i)
    {
        acc = acc OP data[i];
        *dest = acc;
    }
}
```

ä¸å¾—ä¸è¯´ï¼ŒæŒ‡é’ˆæœ‰åˆ©ä¹Ÿæœ‰å¼Šã€‚

### å¾ªç¯å±•å¼€

å¥½å¤„æœ‰äºŒï¼šä¸€æ˜¯å‡å°‘äº†æ¡ä»¶æµ‹è¯•ï¼ŒäºŒæ˜¯å±•å¼€æœ‰åˆ©äºç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ã€‚

``` c++
// 2x1 å±•å¼€
void combine5(vec_ptr v, data_t *dest)
{
    long len = vec_length(v);
    long limit = len - 1;
    data_t *data = get_vec_start(v);
    data_t acc = IDENT;

    int i = 0;
    for (int i = 0; i < limit; i+=2)
    {
        acc = (acc OP data[i]) OP data[i+1];
    }
    for ( ; i < len; ++i)
    {
        acc = acc OP data[i];
    }
    *dest = acc;
}
```

![combine4 VS combine5](/Picbed/2021_02/0202_06.png)

### æé«˜å¹¶è¡Œæ€§

#### å¤šä¸ªç´¯è®¡å˜é‡

``` c++
// 2x2 å±•å¼€
void combine6(vec_ptr v, data_t *dest)
{
    long len = vec_length(v);
    long limit = len - 1;
    data_t *data = get_vec_start(v);
    data_t acc0 = IDENT;
    data_t acc1 = IDENT;

    int i = 0;
    for (int i = 0; i < limit; i+=2)
    {
        acc0 = acc0 OP data[i];
        acc1 = acc1 OP data[i+1];
    }
    for ( ; i < len; ++i)
    {
        acc0 = acc0 OP data[i];
    }
    *dest = acc0 OP acc1;
}
```

![combine5 VS combine6](/Picbed/2021_02/0202_07.png)

æŒ‡ä»¤å¹¶è¡Œåœ¨CPE çš„è¡¨ç°å°±æ˜¯çªç ´å»¶è¿Ÿç•Œé™ï¼Œå½“ç„¶ååé‡ç•Œé™çªç ´ä¸äº†ã€‚

### ç†è§£ç°ä»£å¤„ç†å™¨

å‰é¢è¯´åˆ°çš„ä¼˜åŒ–ç¨‹åºæ€§èƒ½æ˜¯ç¡¬ä»¶æ— å…³çš„ï¼Œæƒ³è¦è¿›ä¸€æ­¥æé«˜ç¨‹åºæ€§èƒ½ï¼Œå¿…é¡»è¦è€ƒè™‘å¤„ç†å™¨å¾®ä½“ç³»ç»“æ„çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å™¨ç”¨æ¥æ‰§è¡ŒæŒ‡ä»¤çš„åº•å±‚ç³»ç»Ÿè®¾è®¡ã€‚

è¿™é‡Œä¼šé‡åˆ°ä¸¤ä¸ªé™åˆ¶ç¨‹åºæ€§èƒ½çš„ç•Œé™ï¼Œä¸€æ˜¯å»¶è¿Ÿç•Œé™ï¼ˆlatency boundï¼‰ï¼Œè¯¸å¦‚æ•°æ®ç›¸å…³ç­‰é™åˆ¶å¤„ç†å™¨å¹¶è¡Œèƒ½åŠ›çš„æƒ…å†µï¼Œèƒ½å¤Ÿå½±å“åˆ°ç¨‹åºæ€§èƒ½ï¼ŒäºŒæ˜¯ååé‡ç•Œé™ï¼ˆthroughput boundï¼‰ï¼Œè¿™æ˜¯åˆ»ç”»å¤„ç†å™¨åŠŸèƒ½å•å…ƒåŸå§‹è®¡ç®—èƒ½åŠ›çš„ï¼Œæ˜¯ç¨‹åºæ€§èƒ½çš„æ ¹æœ¬é™åˆ¶ã€‚

æ‹¿å‰é¢æœ€åçš„ä¼˜åŒ–ç‰ˆæœ¬`combine4()`ä¸¾ä¾‹ï¼š

![latency bound and throughput bound](/Picbed/2021_02/0202_04.png)

åˆæ¥äº†ä¸€ä¸ªç»å…¸çš„ä¾‹å­ï¼Œå¤šé¡¹å¼æ±‚å€¼ã€‚
$$
a_{0} + a_{1}x + a_{2}x^{2}+ ... + a_{n}x^{n}
$$

``` c
// å¸¸è§„æ±‚å’Œ
double poly(vector<double> a, double x, long degree)
{
    double result = a[0];
    double xpwr = x;
    for (long i = 1; i <= degree; ++i)
    {
        result += a[i] * xpwr;		// ä¸€æ¬¡æµ®ç‚¹åŠ æ³•ä¸€æ¬¡æµ®ç‚¹ä¹˜æ³•
        xpwr = x * xpwr;			// ä¸€æ¬¡æµ®ç‚¹ä¹˜æ³•
    }
    return result;
}

// ç§¦ä¹éŸ¶ç®—æ³•
double polyh(vector<double> a, double x, long degree)
{
    double result = a[degree];
    for (long i = degree-1; i >= 0; --i)
    {
        result = a[i] + x * result;		// ä¸€æ¬¡æµ®ç‚¹åŠ æ³•ä¸€æ¬¡æµ®ç‚¹ä¹˜æ³•
        // æ•°æ®ç›¸å…³ï¼Œæ‰€ä»¥ CPE = 3 + 5 = 8
    }
    return result;
}
```

![poly](/Picbed/2021_02/0202_05.png)

csappåœ¨å‡å®šå¦‚ä¸‹æ€§èƒ½å‚æ•°çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ° `poly()` CPEä¸º5ï¼Œ`polyh()` CPEä¸º8ï¼Œå³åè€…æ€§èƒ½ä¸å¦‚å‰è€…ã€‚

é¦–å…ˆæµ®ç‚¹ä¹˜æ³•å•å…ƒæ˜¯æœ‰ä¸¤ä¸ªçš„ï¼Œé‚£ä¹ˆ `a[i] * xpwr` å’Œ `x * xpwr` å¯ä»¥å¹¶è¡Œè®¡ç®—ï¼Œè€Œå¯¹äº `result` çš„æ›´æ–°æ—¶é—´ä¸ºå•¥æ²¡äº†ï¼Œè¿™å°±æ˜¯æµæ°´çº¿çš„åŠŸåŠ³äº†ã€‚

### æ€»ç»“

+ é«˜çº§è®¾è®¡ï¼šé€‰æ‹©åˆé€‚çš„ç®—æ³•å’Œæ•°æ®ç»“æ„
+ åŸºæœ¬ç¼–ç åŸåˆ™ï¼šé¿å…é™åˆ¶ä¼˜åŒ–çš„å› ç´ ï¼Œä½¿ç¼–è¯‘å™¨ç”Ÿæˆé«˜æ•ˆçš„ä»£ç 
  + æ¶ˆé™¤è¿ç»­çš„å‡½æ•°è°ƒç”¨
  + æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨ï¼šå¼•å…¥ä¸­é—´å˜é‡ï¼Œåªåœ¨æœ€åå°†ç»“æœæ›´æ–°åˆ°æ•°ç»„ç­‰ç”¨åˆ°å†…å­˜å¼•ç”¨çš„åœ°æ–¹
+ ä½çº§ä¼˜åŒ–
  + å±•å¼€å¾ªç¯ï¼ˆkx1å±•å¼€ï¼‰
  + ä½¿ç”¨å¤šä¸ªç´¯è®¡å˜é‡ï¼ˆ1xkå±•å¼€ï¼‰å’Œé‡æ–°ç»“åˆç­‰æŠ€æœ¯
  + ç”¨åŠŸèƒ½æ€§çš„é£æ ¼é‡å†™æ¡ä»¶æ“ä½œï¼šå°‘ç”¨æ•°æ®æ§åˆ¶ï¼Œå¤šç”¨æ•°æ®ä¼ é€

# è®¡ç®—æœºç¨‹åºçš„æ„é€ å’Œè§£é‡Šï¼ˆsicpï¼‰

# å‰‘æŒ‡Offer

## chap1 é¢è¯•

## æŠ€æœ¯é¢

+ ç¼–ç¨‹è¯­è¨€ã€æ•°æ®ç»“æ„å’Œç®—æ³•
+ ä»£ç è´¨é‡å¾ˆé‡è¦ï¼Œè¦å…³æ³¨è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šè¾“å…¥ï¼ˆç©ºæŒ‡é’ˆã€ç©ºå­—ç¬¦ä¸²ç­‰ï¼‰ä»¥åŠé”™è¯¯å¤„ç†
+ ç”»å›¾ä½¿æŠ½è±¡é—®é¢˜å½¢è±¡åŒ–ï¼Œä¸¾ä¾‹ä½¿æŠ½è±¡é—®é¢˜å…·ä½“åŒ–ï¼Œåˆ†è§£ä½¿å¤æ‚é—®é¢˜ç®€å•åŒ–

## chap2 åŸºç¡€çŸ¥è¯†

### 01 xxå‡½æ•°

ä¸º MyString ç±»æ·»åŠ èµ‹å€¼è¿ç®—å‡½æ•°ã€‚

``` c++
public:
  	MyString(char *pData = nullptr);
    MyString(const MyString &str);
  	MyString& operator = (const MyString &rhs);	// å£°æ˜
    ~MyString(void);
  
private:
  	char *m_pData;
}

// å®ç°
// è¿”å›ç±»å‹å£°æ˜ä¸ºå¼•ç”¨ï¼Œä»¥å®ç°è¿ç»­èµ‹å€¼ï¼Œå‚æ•°å£°æ˜ä¸º const referenceï¼Œé¿å…å€¼ä¼ é€’çš„å¼€é”€
MyString& MyString::operator = (const MyString &rhs)
{
  	if (this != rhs) {
      	MyString objTemp(rhs);
      	
      	// åŸæœ‰æ•°æ®å’Œæ ˆä¸Šçš„è‡ªåŠ¨å˜é‡äº¤æ¢ï¼Œæ•…è€Œä¸éœ€è¦å…³å¿ƒå†…å­˜é‡Šæ”¾é—®é¢˜
      	char *pTemp = objTemp.m_pData;
      	objTemp.m_pData = m_pData;
      	m_pData = pTemp;
    }
  
  	return *this;
}
```

### 02 å®ç°å•ä¾‹æ¨¡å¼

``` c++
singleton
```

### 09 ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—

ç”¨ä¸¤ä¸ªæ ˆå®ç°ä¸€ä¸ªé˜Ÿåˆ—ã€‚é˜Ÿåˆ—çš„å£°æ˜å¦‚ä¸‹ï¼Œè¯·å®ç°å®ƒçš„ä¸¤ä¸ªå‡½æ•° appendTail å’Œ deleteHead ï¼Œåˆ†åˆ«å®Œæˆåœ¨é˜Ÿåˆ—å°¾éƒ¨æ’å…¥æ•´æ•°å’Œåœ¨é˜Ÿåˆ—å¤´éƒ¨åˆ é™¤æ•´æ•°çš„åŠŸèƒ½ã€‚(è‹¥é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ ï¼ŒdeleteHead æ“ä½œè¿”å› -1 )

[leetcode](https://leetcode-cn.com/problems/yong-liang-ge-zhan-shi-xian-dui-lie-lcof/)

æ€è·¯ï¼šé¢˜æ„æ˜¯æŠŠå…ˆè¿›åå‡ºçš„æ ˆæ”¹é€ æˆå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå®ç°å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œã€‚å¦‚æœæ˜¯ä¸€æ¬¡æ€§è¿ç»­å…¥é˜Ÿåä¸€æ¬¡æ€§è¿ç»­å‡ºé˜Ÿï¼Œé‚£ä¹ˆä¸€ä¸ªæ ˆå€’è…¾åˆ°å¦ä¸€ä¸ªæ ˆå°±å®Œæˆäº†ï¼Œä½†æ­¤å¤„å¹¶æ²¡æœ‰æŒ‡æ˜æ“ä½œåºåˆ—ã€‚å®é™…ä¸Šåˆ†æ²»çš„æƒ³ä¸€æƒ³ï¼Œå¯ä»¥å°†æ•´ä¸ªçš„æ“ä½œåºåˆ—ç”¨å‡ºé˜Ÿæ“ä½œåˆ†å‰²æˆä¸€ä¸ªä¸ªå°æ“ä½œåºåˆ—ï¼Œæ¯ä¸ªæ“ä½œåºåˆ—éƒ½æ»¡è¶³åˆšåˆšå¾ˆå®¹æ˜“å®ç°çš„æ¡ä»¶ã€‚

æ€»çš„æ¥è¯´ï¼šå‹æ ˆåªç®¡å‹å…¥stk1ï¼Œå‡ºæ ˆçš„æ—¶å€™ï¼Œå¦‚æœstk2ç©ºï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„å°æ“ä½œåºåˆ—ï¼Œstk1ä¸­çš„å†…å®¹å…¨éƒ¨å‡ºæ ˆå¹¶å‹å…¥stk2ä¸­ã€‚å€’è…¾å®Œäº†ï¼Œstk2è¦ä¹ˆéç©ºï¼Œè¦ä¹ˆè¿˜æ˜¯ç©ºçš„ï¼Œå¦‚æœæ˜¯ç©ºçš„ï¼Œè¯´æ˜æ•´ä¸ªé˜Ÿåˆ—å°±æ˜¯ç©ºçš„å‘€ï¼Œå¼‚å¸¸å¤„ç†æˆ–è€…æ”¾å›ä¸€ä¸ªçº¦å®šè¡¨ç¤ºé˜Ÿåˆ—ç©ºçš„å€¼ï¼›å¦‚æœstk2éç©ºï¼Œæ ˆé¡¶å…ƒç´ å‡ºæ ˆå¹¶è¿”å›å³å¯ã€‚

``` c++
#include <iostream>
#include <stack>

using namespace std;

class CQueue {
public:
    CQueue() { }

    void appendTail(int value)
    {
        stk1.push(value);
    }

    int deleteHead()
    {
        // åˆ é™¤æ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœstk2ç©ºï¼Œåˆ™stk1å…¨éƒ¨å‡ºæ ˆå¹¶å‹å…¥stk2
        // å¦‚æœæ­¤æ—¶stk2ä¸ç©ºï¼Œåˆ™æ ˆé¡¶å‡ºæ ˆï¼Œå¦åˆ™è¡¨æ˜â€œé˜Ÿåˆ—â€ä¸ºç©º
        if (stk2.empty()) {
            while (!stk1.empty()) {
                stk2.push(stk1.top());
                stk1.pop();
            }
        }

        if (stk2.empty()) {
            return -1;
        } else {
            int tmp = stk2.top();
            stk2.pop();
            return tmp;
        }
    }

private:
    stack<int> stk1, stk2;
};

int main()
{
    CQueue* q = new CQueue();
    q->appendTail(2);
    q->appendTail(3);
    q->appendTail(4);
    cout << q->deleteHead() << endl;
    cout << q->deleteHead() << endl;
    cout << q->deleteHead() << endl;
    cout << q->deleteHead() << endl;
    cout << q->deleteHead() << endl;

    return 0;
}
```

