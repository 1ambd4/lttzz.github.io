---
title: "软件开发"
date: 2022-02-25T21:35:36+08:00
lastmod: 2022-02-25T21:35:36+08:00
draft: true
keywords: []
description: ""
tags: []
categories: []
author: "lttzz"

# You can also close(false) or open(true) something for this content.
# P.S. comment can only be closed
comment: false
toc: true
autoCollapseToc: true
postMetaInFooter: false
hiddenFromHomePage: false
# You can also define another contentCopyright. e.g. contentCopyright: "This is another copyright."
contentCopyright: false
reward: false
mathjax: false
mathjaxEnableSingleDollar: false
mathjaxEnableAutoNumber: false

# You unlisted posts you might want not want the header or footer to show
hideHeaderAndFooter: false

# You can enable or disable out-of-date content warning for individual post.
# Comment this out to use the global config.
#enableOutdatedInfoWarning: false

flowchartDiagrams:
  enable: false
  options: ""

sequenceDiagrams: 
  enable: false
  options: ""

---

<!--more-->

# Android

## Jetpack

Android Jetpack is a set of components, tools and guidance to make great Android apps. They bring together the existing Support Library and Architecture Components and arrange them into four categories:

![](/Picbed/0225-00.png)

## 模块划分

模块划分完后，在工程根目录下新建 `dependencies.gradle` 用于共用编译配置的管理，通过 `apply from: '../dependencies.gradle'` 导入。

``` kotlin
// 配置各个模块共用的参数

apply plugin: 'kotlin-android'
apply plugin: 'kotlin-parcelize'
apply plugin: 'kotlin-kapt' // kotlin语言使用注入框架，databing需要
apply plugin: 'androidx.navigation.safeargs.kotlin' // navigation传参时候的一种安全保护


android {
    compileSdk 31

    defaultConfig {
        minSdk 21
        targetSdk 31

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    buildFeatures {
        dataBinding true
        viewBinding true
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {
    implementation fileTree(includes: ['*.jar'], dir: 'libs')

    //region 平台相关的基础库
    implementation 'androidx.core:core-ktx:1.7.0'
    implementation 'androidx.appcompat:appcompat:1.3.0'
    implementation 'androidx.fragment:fragment-ktx:1.4.1'
    implementation 'androidx.activity:activity-ktx:1.4.0'
    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.0'
    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.0.4'
    //endregion

    //region jetpack libs
    implementation 'androidx.lifecycle:lifecycle-extensions:2.2.0'
    implementation 'androidx.lifecycle:lifecycle-livedata:2.4.1'
    implementation 'androidx.lifecycle:lifecycle-viewmodel:2.4.1'
    implementation 'androidx.lifecycle:lifecycle-runtime:2.4.1'
    implementation 'androidx.lifecycle:lifecycle-livedata-ktx:2.4.1'
    implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.4.1'
    kapt "androidx.lifecycle:lifecycle-common-java8:2.4.1"

    implementation 'androidx.room:room-runtime:2.4.2'
    implementation 'androidx.room:room-common:2.4.2'
    implementation 'androidx.room:room-ktx:2.4.2'
    kapt "androidx.room:room-compiler:2.4.2"

    implementation 'androidx.paging:paging-runtime:3.1.0'
    implementation 'androidx.paging:paging-runtime-ktx:3.1.0'
    implementation 'androidx.paging:paging-common:3.1.0'
    implementation 'androidx.paging:paging-common-ktx:3.1.0'

    implementation 'androidx.work:work-runtime:2.7.1'
    implementation 'androidx.work:work-runtime-ktx:2.7.1'

    implementation 'androidx.navigation:navigation-ui:2.4.1'
    implementation 'androidx.navigation:navigation-ui-ktx:2.4.1'
    implementation 'androidx.navigation:navigation-fragment:2.4.1'
    implementation 'androidx.navigation:navigation-fragment-ktx:2.4.1'
    implementation 'androidx.navigation:navigation-runtime:2.4.1'
    //endregion

    //region test lib
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.3'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.4.0'
    //endregion
}
```

## 协程

``` kotlin
package cn.lttzz.android.common

import kotlinx.coroutines.*
import org.junit.Test
import kotlin.system.measureTimeMillis

class KtCoroutinesTest {

    @Test
    fun testKtCoroutines() {
        // 异步，不阻塞线程，仅仅是返回类型不同
        testLaunch()
        testAsync()

        // 同步，阻塞代码块
        testRunBlocking()

        //
        testJoinAndCancel()

        // testTimeOut()

        testAwait()
    }

    private fun testLaunch() {
        val time: Long = measureTimeMillis {
            GlobalScope.launch {
                Thread.sleep(1000)
                println("test launch1 in ${Thread.currentThread()}")
            }
            GlobalScope.launch {
                Thread.sleep(1000)
                println("test launch2 in ${Thread.currentThread()}")
            }
            Thread.sleep(2000)
            println("test luanch in ${Thread.currentThread()}")
        }
        println("time consumed $time")
    }

    private fun testAsync() {
        val time: Long = measureTimeMillis {
            GlobalScope.async {
                Thread.sleep(1000)
                println("test async1 in ${Thread.currentThread()}")
            }
            GlobalScope.async {
                Thread.sleep(1000)
                println("test async2 in ${Thread.currentThread()}")
            }
            Thread.sleep(2000)
            println("test async in ${Thread.currentThread()}")
        }
        println("time consumed $time")
    }

    private fun testRunBlocking() {
        val time: Long = measureTimeMillis {
            runBlocking {
                println("test runBlocking1 in ${Thread.currentThread()}")
                delay(1000)
                println("test runBlocking2 in ${Thread.currentThread()}")
            }
        }
        println("time consumed $time")
    }

    // 使用join()、cancel()的需要，将代码放到runBlocking里来保证所有协程都能执行完毕，而不是由于主协程结束而终止
    // 挂起函数只能在其他挂起函数里面进行调用
    private fun testJoinAndCancel() = runBlocking {
        val time: Long = measureTimeMillis {
            val L1: Job = GlobalScope.launch {
                println("test JoinAndCancel launch1 in ${Thread.currentThread()}")
            }
            val L2: Job = GlobalScope.launch {
                println("test JoinAndCancel luanch2 in ${Thread.currentThread()}")
            }

            val a2: Deferred<Unit> = GlobalScope.async {
                repeat(20) {
                    println("test JoinAndCancel async2 in ${Thread.currentThread()}, and $it")
                    delay(200)
                }
            }

            a2.join()   // 必须等待a2结束协程，才会执行之后的代码
            // a2.cancelAndJoin()  // 取消协程，并返回主协程
            val a1: Deferred<Unit> = GlobalScope.async {
                println("test JoinAndCancel async1 in ${Thread.currentThread()}")
                a2.cancel() // 取消协程a2
            }
        }
    }

    private fun testTimeOut() = runBlocking {
        val time: Long = measureTimeMillis {
            // withTimeout()计时到时抛出异常并结束协程
            withTimeout(3000) {
                launch {
                    repeat(2000) {
                        println("withTimeout $it in ${Thread.currentThread()}")
                        delay(100)
                    }
                }
            }
            // withTimeOutOrNull()计时到后结束协程但不抛异常
            withTimeoutOrNull(1000) {
                launch {
                    repeat(2000) {
                        println("withTimeoutOrNull $it in ${Thread.currentThread()}")
                        delay(100)
                    }
                }
            }
        }
        println("time consumed $time")
    }

    private fun testAwait() = runBlocking {
        val time: Long = measureTimeMillis {
            val a2: Deferred<Int> = async {
                println("test Await in ${Thread.currentThread()}")
                delay(3000)
                200
            }

            val a1: Deferred<Int> = async {
                println("test Await in ${Thread.currentThread()}")
                delay(2000)
                100
            }

            // 会等待协程执行结束才获取结果
            println("result of function: ${a1.await()} and ${a2.await()}")
        }
        println("time consumed $time")
    }
}
```

## LiveData

``` kotlin
// 声明一个LiveData
val liveA = mutableLiveData<String>()
// 在需要的时候赋值
liveData.value = "xxxxxx"


//////////////////////////////////
// UI中，观察者模式，在active状态下可以感知数据变化
val liveAObserver = Observer<String> {
  	value?.let{
      	// do something
    }
}
liveA.observe(viewLifeCycleOwner, liveAObserver)
```

### Map

### SwitchMap

### Mediator

## DataBinding

### 配置

``` kotlin
// 在module的build.gradle中配置
apply plugin: 'kotlin-kapt'

android {
  	// AS4.0之后
  	dataBinding {
      	enable true
    }
  	// AS4.1之前
  	bindingFeatures {
      	dataBinding = true
      	// view binding
      	// viewBinding = true
    }
}
```

### UI

``` xml
<layout>
	<data>
  
  </data>
	<LinearLayout>
  <!--- 原有的xml布局原样放置在此处即可，而将数据放置在data标签下 -->
  </LinearLayout>
</layout>
```

### xml中的数据类型

+ `variable`声明变量

+ `import`导入类型

+ 绑定`xml`与`data`的方式：`@{}`、`@={}`（双向绑定）

+ 可以使用表达式、函数调用、属性参数

+ `??`判空

+ `?:`三目运算符

+ `+`拼接字符串，使用\`\`反引号

+ `default`设置默认值

+ `include`绑定

+ 点击事件

  ``` xml
  onclick="@{()->vm.click()}"
  onclick="@{(v)->vm.click()}"
  onclick="@{()->vm.click(context)}"
  onclick="@{BingHelp::staticClick}"
  onclick="@{callback}"
  ```

+ `EditText`的双向绑定`text="@{={etStr}}"`

+ UI中关联xml的dataBinding

  ``` kotlin
  // 在activity中
  var binding = 
  		DataBindingUtil.setContentView<ActivityBaseUseBinding>(this, R.layout.acctivity_base_use)
  
  // 在fragment中
  xxxBinding.inflater()
  ```

  ### 进阶用法

  1. `android:onCheckedChange="@{(switch, checked)->vm.broatdast(checked)}"`
  2. Binding响应UI的data bean
  3. Adapter用于列表的适配器，`include`
  4. `@BindingCoversion`转化支持
  5. `BindingAdatper`高级支持
  6. `InverseBindingAdapter`反向绑定
  7. `@bindingMethods`适配扩展`binding`的函数

  ### 经验之谈

  1. TextView的text属性，data不能为数值类型
  2. xml中字符不能为中文
  3. 反射的属性、函数必须为`public`
  4. 使用liveData作为dataBinding时，切记UI中设置`binding.lifecycleOwner`
  5. `obesrvableField`数据的时候，某些场合必须初始化，否则运行报错，且不易排查
  6. 常用gradle指令
     1. `gradlew app:build`
     2. `gradlew app:dependencies`
     3. `--stacktrace  --debug  --offline clean  rebuild  clear  cache  delete  build`



## 排错

### android.content.res.Resources$NotFoundException

``` text
android.content.res.Resources$NotFoundException: String resource ID #0x14
		at android.content.res.Resources.getText(Resources.java:338)
		at android.widget.TextView.setText(TextView.java:5494)
```

错因是`setText()`不能接受`Int`类型数据，在数字后面拼接上空字符串即可`+""`。
